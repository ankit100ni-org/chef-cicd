name: CI/CD Pipeline

# on:
#   push:
#     branches:
#       - dev

on:
  pull_request:
    types: [opened, reopened, edited, synchronize]
    branches:
      - dev

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - name: justForTesting
      run: ls; pwd; tee

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Installing Workstation
      run: wget https://packages.chef.io/files/stable/chef-workstation/23.12.1055/ubuntu/22.04/chef-workstation_23.12.1055-1_amd64.deb; sudo dpkg -i chef-workstation_23.12.1055-1_amd64.deb

    - name: Workstation Setup
      run: |
        sudo pwd; sudo ls -a; sudo tree; sudo tree .github
        sudo chmod 777 .github/workflows/setup.sh
        sudo sh .github/workflows/setup.sh
        sudo mkdir -p ~/.chef
        sudo chmod 777 ~/.chef
        sudo echo "${{ secrets.CHEFADMIN_KEY }}" > ~/.chef/chefadmin.pem
        sudo ls -lhrt ~/.chef/
        sudo chown runner:runner ~/.chef/chefadmin.pem
        sudo chmod 400 ~/.chef/chefadmin.pem
        sudo cat ~/.chef/chefadmin.pem
        echo "testing recommit"

    - name: Knife Setup
      run: |
        sudo knife ssl fetch
        sudo knife ssl check
        sudo knife client list

    - name: Metadata Check
      run: |
        # Cookbook validation
        # Version check
        - bash: |
            # Define a function that returns true if cookbook version passed as argument 1
            # is greater than or equal to the cookbook version passed as argument 2
            semver_gte() {
              [ "$1" == "$( echo -e "$1\n$2" | sort -rV | head -n1 )" ]
            }
            # Grab the version strings from the main and current branches
            dev_version=$( git show origin/dev:metadata.rb | grep "^version" | tr '"' "'" | cut -f2 -d\' )
            branch_version=$( grep "^version" metadata.rb | tr '"' "'" | cut -f2 -d\' )
            echo 'Feature branch cookbook version:' $branch_version
            echo 'dev branch cookbook version:' $dev_version
            if semver_gte "$dev_version" "$branch_version"; then
              echo 'ERROR: Cookbook version must be greater than the version in the dev branch'
              exit 1
            fi
          displayName: 'Cookbook version check' 